<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Esparagoza Dental Hub</title>
  <link rel="icon" href="https://i.imgur.com/t942gBV.png">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body {
      background: linear-gradient(135deg, #b3d9ff, #e6f0ff);
      min-height: 100vh;
      overflow-x: hidden;
      color: #0b3756;
    }

    header {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      padding: 15px 20px;
      background: linear-gradient(90deg, #2ea0ff, #0b6bcb);
      color: white;
    }

    header img {
      height: 60px;
    }

    /* Menu Button */
    #menuBtn {
      position: absolute;
      right: 20px;
      background: none;
      border: none;
      color: white;
      font-size: 26px;
      cursor: pointer;
    }

    /* Section transitions */
    section {
      width: 100%;
      min-height: 100vh;
      padding: 30px 20px;
      display: none;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    section.active { display: block; opacity: 1; }

    /* Home Page */
    #homePage {
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #2ea0ff, #0b6bcb);
      color: white;
      padding: 60px 20px;
    }

    #homePage img {
      width: 90px;
      margin-bottom: 20px;
    }

    #homePage h2 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    #homePage p {
      font-size: 1rem;
      margin-bottom: 20px;
    }

    .main-btn {
      background: white;
      color: #0b6bcb;
      font-weight: 600;
      padding: 12px 24px;
      border: none;
      border-radius: 40px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      transition: 0.3s;
    }

    .main-btn:hover {
      transform: scale(1.05);
      background: #f8faff;
    }

    /* Menu Modal */
    #modalOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    #modalMenu, #sectionContent {
      background: #fff;
      border-radius: 14px;
      max-width: 420px;
      width: 90%;
      padding: 20px;
      box-shadow: 0 12px 30px rgba(0,0,0,.1);
      animation: fadeIn .3s ease;
      max-height: 85vh;
      overflow-y: auto;
    }

    .menu-tile {
      background: rgba(11,107,203,.1);
      color: #0b6bcb;
      font-weight: 600;
      text-align: center;
      border: none;
      padding: 14px;
      width: 100%;
      margin: 8px 0;
      border-radius: 10px;
      cursor: pointer;
      transition: .2s;
    }
    .menu-tile:hover { background: rgba(11,107,203,.25); }

    #closeModal, #backBtn {
      background: #0b6bcb;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    #closeModal { position: absolute; top: 16px; right: 20px; font-size: 18px; }

    @keyframes fadeIn { from{opacity:0;transform:scale(.9)} to{opacity:1;transform:scale(1)} }

    /* Booking Page styling */
    .back-btn {
      display: inline-block;
      background: linear-gradient(90deg, #2ea0ff, #0b6bcb);
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      margin-bottom: 20px;
      cursor: pointer;
      border: none;
      font-weight: 500;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 40px rgba(7,36,63,.06);
      margin: 18px auto;
      max-width: 520px;
      padding: 18px;
      width: 94%;
    }

    .day-tile {
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: #fff;
      color: #0b6bcb;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
      min-width: 0;
      overflow: hidden;
    }

    .day-tile.booked {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }

    @media (min-width: 768px) {
      #homePage h2 { font-size: 2.5rem; }
      .card { max-width: 600px; }
    }
  </style>
</head>
<body>

  <!-- üîπ Header with logo and menu -->
  <header>
    <img src="https://i.imgur.com/t942gBV.png" alt="Logo">
    <button id="menuBtn">&#9776;</button>
  </header>

  <!-- üîπ Home Page -->
  <section id="homePage" class="active">
    <img src="https://i.imgur.com/t942gBV.png" alt="Logo">
    <h2>Esparagoza Dental Hub</h2>
    <p id="todayDate"></p>
    <p><b>Your dentist is IN</b></p>
    <p>Hi, stay safe by following our protocols. Thanks!</p>
    <button class="main-btn" id="bookNowBtn">Make an Appointment</button>
  </section>

  <!-- üîπ Menu Modal -->
  <div id="modalOverlay">
    <div id="modalMenu">
      <button id="closeModal">√ó</button>
      <h2 style="text-align:center;color:#0b6bcb;">Menu</h2>
      <button class="menu-tile" data-section="about">About Us</button>
      <button class="menu-tile" data-section="services">Services</button>
      <button class="menu-tile" data-section="protocols">Protocols</button>
      <button class="menu-tile" data-section="contact">Contact Us</button>
    </div>
    <div id="sectionContent" style="display:none;position:relative;">
      <button id="backBtn">‚Üê Back</button>
      <div id="sectionBody" style="margin-top:10px;text-align:center;"></div>
    </div>
    </div>

  <!-- ------------------ Part 2: Booking Page HTML ------------------ -->
<section id="bookingPage">
  <div style="max-width:1100px;margin:0 auto;padding:20px;">
    <button class="back-btn" id="backHomeBtn">‚Üê Back to Home</button>

    <div class="card cal-card" style="margin-top:8px;">
      <div class="cal-top">
        <button class="nav-btn" id="prevMonth">‚Äπ</button>
        <div class="cal-month" id="monthYear"></div>
        <button class="nav-btn" id="nextMonth">‚Ä∫</button>
      </div>

      <div class="weeknames">
        <span>Sun</span><span>Mon</span><span>Tue</span>
        <span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
      </div>

      <div class="cal-grid" id="calendarDays"></div>
      <p style="font-size:13px;color:#666;margin-top:8px;text-align:center">
        Closed or fully booked dates are grayed out.
      </p>
    </div>

    <div class="card" style="margin-top:18px;">
      <h2 style="color:#0b3756;margin-bottom:12px;text-align:center;">Book an Appointment</h2>

      <form id="bookingForm">
        <label>Full Name</label>
        <input id="name" type="text" required>

        <label>Email</label>
        <input id="email" type="email" required>

        <label>Phone</label>
        <input id="phone" type="tel" required>

        <label>Service</label>
        <select id="service" required>
          <option value="">Select Service</option>
          <option>Pediatric Dentistry</option>
          <option>Restorative Dentistry (Tooth Filling)</option>
          <option>Prosthodontics</option>
          <option>Veneers Dental Crown</option>
          <option>Cosmetic Dentistry</option>
          <option>Oral Surgery</option>
          <option>Orthodontics</option>
        </select>

        <label>Date</label>
        <input id="date" type="text" readonly placeholder="Select date from calendar" required>

        <label>Time</label>
        <select id="time" required>
          <option value="">Select a time slot</option>
        </select>

        <div id="slotsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin:12px 0;"></div>

        <label>Notes (optional)</label>
        <textarea id="notes" rows="3"></textarea>

        <button type="submit" style="margin-top:8px;" class="main-btn">Submit Booking</button>
      </form>
    </div>
  </div>
</section>

<!-- ------------------ Part 2: Scripts ------------------ -->
<script type="module">
/* === Imports === */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set, push, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* === Firebase config - replace if you want your own === */
const firebaseConfig = {
  apiKey: "AIzaSyCV39b2CkzS_tt75SVXa6z95s6f4qVlfLg",
  authDomain: "esparagozadentalclinic-6a744.firebaseapp.com",
  databaseURL: "https://esparagozadentalclinic-6a744-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esparagozadentalclinic-6a744",
  storageBucket: "esparagozadentalclinic-6a744.firebasestorage.app",
  messagingSenderId: "959639046373",
  appId: "1:959639046373:web:ccf39df13d94e527fcec0c"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* === Page elements === */
const homePage = document.getElementById("homePage");
const bookingPage = document.getElementById("bookingPage");
const bookNowBtn = document.getElementById("bookNowBtn");
const backHomeBtn = document.getElementById("backHomeBtn");
const menuBtn = document.getElementById("menuBtn");
const modalOverlay = document.getElementById("modalOverlay");
const modalMenu = document.getElementById("modalMenu");
const sectionContent = document.getElementById("sectionContent");
const sectionBody = document.getElementById("sectionBody");
const closeModal = document.getElementById("closeModal");
const backBtn = document.getElementById("backBtn");

const calendarDays = document.getElementById("calendarDays");
const monthYear = document.getElementById("monthYear");
const prevMonth = document.getElementById("prevMonth");
const nextMonth = document.getElementById("nextMonth");
const dateInput = document.getElementById("date");
const timeSelect = document.getElementById("time");
const slotsGrid = document.getElementById("slotsGrid");

const bookingForm = document.getElementById("bookingForm");
const toastWrap = document.getElementById("toastWrap");

/* === App state === */
let currentDate = new Date();
let displayedYear = null, displayedMonth = null;
const TIME_SLOTS = [
  "9:00 AM","9:30 AM","10:00 AM","10:30 AM","11:00 AM","11:30 AM",
  "12:00 NN","12:30 PM","1:00 PM","1:30 PM","2:00 PM","2:30 PM",
  "3:00 PM","3:30 PM","4:00 PM"
];
let maxSlots = 1;           // pulled from /settings/maxSlots if you set
let closedDates = {};       // pulled from /closed_dates
// slot_counts structure in DB: slot_counts/{YYYY-MM-DD}/{slot_key} => integer

/* === Helpers === */
const fmtDateKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const slotKey = s => s.replace(/[^a-zA-Z0-9]/g,"_").toLowerCase();
function showToast(msg, type="info") {
  const t = document.createElement("div");
  t.className = "toast " + (type || "");
  t.textContent = msg;
  toastWrap.appendChild(t);
  setTimeout(()=>t.classList.add("show"),50);
  setTimeout(()=>t.remove(), 3000);
}

/* === Modal/Menu logic (header menu is only shown on home page per design) === */
function openModal() {
  modalOverlay.style.display = "flex";
  modalMenu.style.display = "block";
  sectionContent.style.display = "none";
}
function closeModalFn(){
  modalOverlay.style.display = "none";
}
menuBtn?.addEventListener("click", openModal);
closeModal?.addEventListener("click", closeModalFn);
modalOverlay?.addEventListener("click", e => {
  if (e.target === modalOverlay) closeModalFn();
});
backBtn?.addEventListener("click", () => {
  sectionContent.style.display = "none"; modalMenu.style.display = "block";
});

/* centered modal section content */
const modalData = {
  about: `
    <div style="text-align:center;">
      <img src="https://i.imgur.com/t942gBV.png" class="modal-logo" alt="logo" style="margin-bottom:10px;width:90px;">
      <h3>About Us</h3>
      <p style="margin-top:8px;"><b>Orthodontics, Implant & General Dentistry</b></p>
      <p style="margin-top:8px;">Dr. Jeff Esparagoza provides dental services such as orthodontics, implant, and general dentistry.</p>
    </div>
  `,
  services: `
    <div style="text-align:center;">
      <h3>Our Dental Services</h3>
      <ul style="margin-top:10px;line-height:1.8;list-style:none;padding:0;">
        <li>Pediatric Dentistry ‚Äî 30 minutes</li>
        <li>Restorative Dentistry (Tooth Filling) ‚Äî 30 minutes</li>
        <li>Prosthodontics ‚Äî 30 minutes</li>
        <li>Veneers Dental Crown ‚Äî 30 minutes</li>
        <li>Cosmetic Dentistry ‚Äî 30 minutes</li>
        <li>Oral Surgery ‚Äî 30 minutes</li>
        <li>Orthodontics ‚Äî 30 minutes</li>
      </ul>
    </div>
  `,
  protocols: `
    <div style="text-align:center;">
      <h3>COVID-19 Dental Practice Protocols</h3>
      <p style="margin-top:8px;">COVID-19 is caused by SARS-CoV-2. Common symptoms include fever, cough, fatigue, and loss of smell.</p>
      <p style="margin-top:8px;">Dental professionals are at high risk; everyone must follow these protocols:</p>
      <ul style="margin-top:10px;line-height:1.8;list-style:none;padding:0;">
        <li>NO MASK, NO ENTRY</li>
        <li>OBSERVE SOCIAL DISTANCING</li>
        <li>ALCOHOL AVAILABLE FOR PATIENT USE</li>
        <li>ONLY PATIENTS ALLOWED INSIDE TREATMENT ROOM</li>
        <li>NO COMPANIONS EXCEPT MINORS/ELDERS</li>
      </ul>
      <p style="margin-top:8px;"><b>Clinic Hours:</b> Monday ‚Äì Saturday, 9:00 AM ‚Äì 4:00 PM</p>
    </div>
  `,
  contact: `
    <div style="text-align:center;">
      <h3>Contact Us</h3>
      <p style="margin-top:8px;">
       üìç Kidapawan City, North Cotabato, Philippines
      </p>
      <p style="margin-top:6px;">üìû 0977 780 9537</p>
      <p style="margin-top:4px;">üìß esparagoza.jeffrey@gmail.com</p>
    </div>
  `
};

/* menu tile click handler (semi-transparent blue tiles) */
document.querySelectorAll(".menu-tile").forEach(btn => {
  btn.addEventListener("click", () => {
    const sec = btn.dataset.section;
    sectionBody.innerHTML = modalData[sec] || "";
    modalMenu.style.display = "none";
    sectionContent.style.display = "block";
  });
});

/* hide menu button on booking page and show only on home */
function showHomeHeaderMenu(show) {
  const el = document.getElementById("menuBtn");
  if (!el) return;
  el.style.display = show ? "block" : "none";
}

/* === Page transitions: Home <-> Booking === */
bookNowBtn.addEventListener("click", () => {
  // hide menu button on booking page
  showHomeHeaderMenu(false);

  // transition styles: fade out home, fade in booking
  homePage.classList.remove("active");
  setTimeout(()=> {
    bookingPage.classList.add("active");
    window.scrollTo({top:0, behavior:"smooth"});
  }, 180);
});

backHomeBtn.addEventListener("click", () => {
  bookingPage.classList.remove("active");
  setTimeout(()=> {
    homePage.classList.add("active");
    showHomeHeaderMenu(true);
    window.scrollTo({top:0, behavior:"smooth"});
  }, 180);
});

/* === Calendar: render and navigation === */
function renderCalendar(dateObj) {
  const year = dateObj.getFullYear();
  const month = dateObj.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  monthYear.textContent = dateObj.toLocaleDateString(undefined, { month: "long", year: "numeric" });
  calendarDays.innerHTML = "";

  // blank slots
  for (let i = 0; i < firstDay; i++) {
    const blank = document.createElement("div");
    calendarDays.appendChild(blank);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const tile = document.createElement("div");
    tile.className = "day-tile";
    tile.textContent = d;
    const thisDate = new Date(year, month, d);
    const iso = fmtDateKey(thisDate);

    // if closed date in DB, gray it out
    if (closedDates[iso]) {
      tile.classList.add("booked");
    } else {
      // click selects the date (only future and today)
      const today = new Date(); today.setHours(0,0,0,0);
      if (thisDate.getTime() < today.getTime()) {
        tile.style.opacity = 0.5;
        tile.style.cursor = "not-allowed";
      } else {
        tile.addEventListener("click", () => {
          dateInput.value = thisDate.toLocaleDateString();
          loadSlotsForDate(iso);
        });
      }
    }

    // highlight today
    const t = new Date(); t.setHours(0,0,0,0);
    if (thisDate.getTime() === t.getTime()) tile.style.border = "2px solid #0b6bcb";

    calendarDays.appendChild(tile);
  }
}

/* prev/next month */
prevMonth.addEventListener("click", () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar(currentDate);
});
nextMonth.addEventListener("click", () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar(currentDate);
});

/* === Firebase listeners for closed dates, maxSlots and slot_counts === */
onValue(ref(db, "closed_dates"), snap => {
  closedDates = snap.exists() ? snap.val() : {};
  renderCalendar(currentDate);
});
onValue(ref(db, "settings/maxSlots"), snap => {
  maxSlots = snap.exists() ? snap.val() : 1;
});
onValue(ref(db, "slot_counts"), snap => {
  // we keep slot_counts in memory only if you need to use it globally; here we update UI when needed
  renderCalendar(currentDate);
});

/* === Load available slots for a selected date (gray -> FULL when reached) === */
async function loadSlotsForDate(dateKey) {
  // clear time select and tiles
  timeSelect.innerHTML = '<option value="">Select a time slot</option>';
  slotsGrid.innerHTML = "";

  // fetch slot counts for that date
  const countsSnap = await get(ref(db, `slot_counts/${dateKey}`));
  const counts = countsSnap.exists() ? countsSnap.val() : {};

  TIME_SLOTS.forEach(slot => {
    const k = slotKey(slot);
    const c = counts[k] || 0;
    const full = c >= maxSlots;

    // populate dropdown
    const opt = document.createElement("option");
    opt.value = slot;
    opt.textContent = full ? `${slot} ‚Äî FULL` : slot;
    if (full) opt.disabled = true;
    timeSelect.appendChild(opt);

    // also create tile buttons grid (visual)
    const b = document.createElement("button");
    b.className = "slot-btn";
    b.textContent = slot;
    if (full) {
      b.classList.add("booked");
      b.disabled = true;
      b.textContent = slot + " üîí";
    } else {
      b.addEventListener("click", () => {
        timeSelect.value = slot;
        // highlight selected tile style
        document.querySelectorAll(".slot-btn").forEach(el => el.classList.remove("selected"));
        b.classList.add("selected");
      });
    }
    slotsGrid.appendChild(b);
  });
}

/* === Booking submit -> atomically increment slot count and write booking === */
bookingForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const service = document.getElementById("service").value;
  const date = document.getElementById("date").value;
  const time = document.getElementById("time").value;
  const notes = document.getElementById("notes").value.trim();

  if (!name || !email || !phone || !service || !date || !time) {
    showToast("Please complete all fields", "error");
    return;
  }

  // convert selected date back to ISO key (we used fmtDateKey)
  const parsed = new Date(date);
  const dateKey = fmtDateKey(parsed);

  const sKey = slotKey(time);
  const slotRef = ref(db, `slot_counts/${dateKey}/${sKey}`);

  try {
    // atomic increment
    const tx = await runTransaction(slotRef, current => {
      if (!current) current = 0;
      if (current >= maxSlots) return; // abort
      return current + 1;
    });

    if (!tx.committed) {
      showToast("Slot is already full. Choose another slot.", "error");
      // refresh slots
      await loadSlotsForDate(dateKey);
      return;
    }

    // push booking record (you can adjust path as needed)
    await set(push(ref(db, `appointments/${dateKey}/${sKey}`)), {
      name, email, phone, service, date: dateKey, time, notes, createdAt: new Date().toISOString()
    });

    showToast("Booking successful! Thank you.", "success");
    bookingForm.reset();
    dateInput.value = "";
    timeSelect.innerHTML = '<option value="">Select a time slot</option>';
    slotsGrid.innerHTML = "";

    // re-render calendar to show booked state if applicable
    renderCalendar(currentDate);
  } catch (err) {
    console.error(err);
    showToast("Booking failed. Try again.", "error");
  }
});

/* === Initialize UI === */
(function init() {
  // show home menu button, home active, booking hidden initially
  showHomeHeaderMenu(true);
  homePage.classList.add("active");
  bookingPage.classList.remove("active");
  // set today's date text on home (if element exists)
  const todayEl = document.getElementById("todayDate");
  if (todayEl) todayEl.textContent = "Today is " + new Date().toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
  // render calendar
  renderCalendar(currentDate);
})();
</script>
</body>
</html>
