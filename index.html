<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Esparagoza Dental Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<style>
  :root{
    --brand:#0b6bcb;
    --accent:#2ea0ff;
    --success:#00b386;
    --danger:#d9534f;
    --muted:#607f9a;
    --card:#ffffff;
    --radius:12px;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",sans-serif}
  html,body{height:100%}
  body{
    background:linear-gradient(180deg,#e9f4ff 0%,#f4f9ff 100%);
    color:var(--brand);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
  }

  /* --------- layout wrappers --------- */
  .app{max-width:1100px;margin:18px auto;padding:0 16px;position:relative}
  header.topbar{
    position:fixed;left:50%;transform:translateX(-50%);top:12px;width:calc(100% - 32px);max-width:1100px;z-index:60;
    display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;border-radius:14px;
    background:transparent;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{height:56px;border-radius:10px}
  .brand .title{font-weight:700;color:var(--brand);font-size:18px}

  /* --------- top nav - desktop links & underline --------- */
  nav.desktop-nav{display:flex;gap:12px;align-items:center}
  nav.desktop-nav a{position:relative;color:rgba(11,107,203,0.96);text-decoration:none;font-weight:700;padding:8px 10px;border-radius:6px}
  /* underline animation */
  nav.desktop-nav a::after{
    content:"";position:absolute;left:12px;right:12px;bottom:6px;height:3px;border-radius:6px;background:transparent;transition:all .22s ease;
  }
  nav.desktop-nav a:hover::after{background:var(--brand)}
  /* will show underline for active */
  nav.desktop-nav a.active::after{background:var(--brand)}

  /* hamburger for mobile (visible on small screens) */
  .hamburger{display:none;background:linear-gradient(90deg,var(--accent),var(--brand));color:#fff;border:none;padding:8px 12px;border-radius:10px;font-size:18px;cursor:pointer}
  @media(max-width:900px){ nav.desktop-nav{display:none} .hamburger{display:inline-flex} }

  /* --------- floating dropdown overlay (desktop only) --------- */
  .nav-overlay{
    position:fixed;left:50%;transform:translateX(-50%);top:74px;z-index:55;max-width:980px;width:calc(100% - 32px);
    pointer-events:none; /* enabled only when visible */
  }
  .overlay-card{
    background:var(--card);border-radius:12px;box-shadow:0 20px 60px rgba(7,36,63,0.12);padding:18px;
    opacity:0;transform:translateY(-6px) scale(.995);transition:opacity .26s ease, transform .26s ease;
    pointer-events:auto;
  }
  .nav-overlay.show .overlay-card{opacity:1;transform:translateY(0) scale(1)}
  /* hide overlay on small screens */
  @media(max-width:900px){ .nav-overlay{display:none} }

  /* --------- front page (hero) --------- */
  #frontPage{
    position:relative;margin-top:22px;border-radius:14px;overflow:hidden;
    background-image: url('https://i.imgur.com/EHVhWYb.jpeg'); background-size:cover; background-position:center;
    min-height:70vh;display:flex;align-items:center;justify-content:center;padding:28px;
    box-shadow:0 12px 40px rgba(7,36,63,0.08);
  }
  .front-overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.28), rgba(255,255,255,0.02));}
  .hero{position:relative;z-index:2;max-width:920px;width:100%;text-align:center;color:#fff;padding:36px;border-radius:12px}
  .logo-big{width:140px;margin:0 auto 12px;border-radius:8px}
  .welcome{font-weight:700;font-size:28px;color:#fff;text-shadow:0 6px 20px rgba(0,0,0,0.35)}
  .meta-row{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:12px;flex-wrap:wrap}
  .pill{background:rgba(255,255,255,0.14);padding:10px 14px;border-radius:999px;font-weight:700}

  .cta{margin-top:18px}
  .cta .btn{background:linear-gradient(90deg,var(--accent),var(--brand));color:#fff;border:none;padding:14px 20px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 12px 30px rgba(11,107,203,0.18)}
  .cta .btn:active{transform:translateY(1px)}

  /* --------- booking page (hidden initially) --------- */
  main#bookingPage{opacity:0;transform:translateY(12px);transition:opacity .5s ease, transform .5s ease;margin-top:18px}
  main#bookingPage.show{opacity:1;transform:translateY(0)}
  .book-logo{display:block;margin:8px auto 10px auto;width:96px}

  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(7,36,63,0.06);margin-bottom:14px}
  label{display:block;margin:8px 0 6px;color:var(--brand);font-weight:700}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6f0fb}
  button.btn-submit{background:linear-gradient(90deg,var(--accent),var(--brand));color:#fff;padding:12px;border-radius:10px;border:none;font-weight:800;cursor:pointer;width:100%}

  /* calendar */
  .weeknames{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;color:var(--muted);font-weight:700;text-align:center;margin-bottom:8px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .day-tile{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#fff;color:var(--brand);font-weight:700;cursor:pointer}
  .day-tile.closed{background:#e6e6e6;color:#888;cursor:not-allowed}
  .day-tile.today{border:2px solid var(--brand)}

  .slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin:10px 0}
  .slot-btn{padding:10px;border-radius:8px;border:none;background:#eef7ff;color:var(--brand);font-weight:700;cursor:pointer}
  .slot-btn.booked{background:#d0d0d0;color:#666;cursor:not-allowed}
  .slot-btn.selected{background:var(--brand);color:#fff}

  /* modal (for mobile menu & content) */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.36);backdrop-filter:blur(3px);z-index:80;justify-content:center;align-items:center}
  .modal-overlay.show{display:flex}
  .modal-box{background:#fff;border-radius:12px;padding:18px;max-width:420px;width:92%;box-shadow:0 12px 40px rgba(7,36,63,0.12);}

  /* toast */
  .toast-wrap{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);z-index:120}
  .toast{background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;margin-top:8px;opacity:0;transition:opacity .2s}
  .toast.show{opacity:1}

  /* small screens */
  @media(max-width:900px){
    .hero{padding:22px}
    .logo-big{width:110px}
    .nav-overlay{display:none}
    header.topbar{top:8px;padding:8px 10px}
  }
</style>
</head>
<body>
  <div class="app">
    <!-- Topbar -->
    <header class="topbar" role="banner" aria-label="Main navigation">
      <div class="brand">
        <img src="https://i.imgur.com/t942gBV.png" alt="logo">
        <div class="title">Esparagoza Dental Hub</div>
      </div>

      <!-- Desktop nav -->
      <nav class="desktop-nav" id="desktopNav" aria-hidden="false">
        <a href="#" data-section="home" class="active">Home</a>
        <a href="#" data-section="about">About Us</a>
        <a href="#" data-section="services">Services</a>
        <a href="#" data-section="protocols">Protocols</a>
        <a href="#" data-section="contact">Contact Us</a>
      </nav>

      <!-- Mobile hamburger (opens modal) -->
      <button class="hamburger" id="hamburgerBtn" aria-label="Open menu">‚ò∞</button>
    </header>

    <!-- Floating overlay for desktop dropdowns (floating white box) -->
    <div class="nav-overlay" id="navOverlay" aria-hidden="true">
      <div class="overlay-card" id="overlayCard" role="region" aria-live="polite"></div>
    </div>

    <!-- FRONT / HERO -->
    <section id="frontPage" aria-label="Welcome">
      <div class="front-overlay"></div>
      <div class="hero">
        <img src="https://i.imgur.com/t942gBV.png" class="logo-big" alt="logo">
        <div class="welcome">Welcome to Esparagoza Dental Clinic</div>
        <div class="meta-row">
          <div class="pill" id="todayDate">Today</div>
          <div class="pill" id="dentistStatus">Dentist: ...</div>
        </div>
        <div class="cta">
          <button class="btn" id="toBookingBtn">Make an Appointment</button>
        </div>
      </div>
    </section>

    <!-- Booking page (hidden until CTA) -->
    <main id="bookingPage" aria-hidden="true">
      <img src="https://i.imgur.com/t942gBV.png" class="book-logo" alt="logo">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <button id="prevMonth" class="btn-small">‚óÄ</button>
          <div id="monthTitle" style="font-weight:800;color:var(--brand)"></div>
          <button id="nextMonth" class="btn-small">‚ñ∂</button>
        </div>
        <div class="weeknames"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
        <div id="calGrid" class="cal-grid"></div>
      </div>

      <section class="card" id="bookingFormSection">
        <h3 style="color:var(--brand);margin-bottom:8px">Book an Appointment</h3>
        <form id="bookingForm">
          <label>Full name</label>
          <input id="name" type="text" required>
          <label>Email</label>
          <input id="email" type="email" required>
          <label>Phone</label>
          <input id="phone" type="text" required>
          <label>Service</label>
          <select id="service" required>
            <option value="">Select service</option>
            <option>Pediatric Dentistry</option>
            <option>Restorative Dentistry (Tooth Filling)</option>
            <option>Prosthodontics</option>
            <option>Veneers Dental Crown</option>
            <option>Cosmetic Dentistry</option>
            <option>Oral Surgery</option>
            <option>Orthodontics</option>
          </select>

          <label>Date</label>
          <input id="date" type="text" readonly required placeholder="Choose a date">
          <label>Time</label>
          <input id="time" type="text" readonly required placeholder="Choose a time slot">
          <div id="slotsGrid" class="slots" aria-live="polite"></div>

          <label>Notes (optional)</label>
          <textarea id="notes" rows="2" placeholder="Any notes"></textarea>

          <div style="margin-top:12px">
            <button class="btn-submit" type="submit">Submit Booking</button>
          </div>
        </form>
      </section>
    </main>

    <!-- Mobile modal for menu & section content -->
    <div class="modal-overlay" id="mobileModal" aria-hidden="true">
      <div class="modal-box" role="dialog" aria-modal="true" id="mobileModalBox">
        <div id="mobileModalContent"></div>
      </div>
    </div>

    <div class="toast-wrap" id="toastWrap"></div>
      </div>

  <script type="module">
/* =========== Imports =========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set, push, runTransaction, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* =========== Firebase config =========== */
const firebaseConfig = {
  apiKey: "AIzaSyCV39b2CkzS_tt75SVXa6z95s6f4qVlfLg",
  authDomain: "esparagozadentalclinic-6a744.firebaseapp.com",
  databaseURL: "https://esparagozadentalclinic-6a744-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esparagozadentalclinic-6a744",
  storageBucket: "esparagozadentalclinic-6a744.firebasestorage.app",
  messagingSenderId: "959639046373",
  appId: "1:959639046373:web:ccf39df13d94e527fcec0c"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* =========== DOM refs =========== */
const desktopNav = document.getElementById("desktopNav");
const navOverlay = document.getElementById("navOverlay");
const overlayCard = document.getElementById("overlayCard");
const hamburgerBtn = document.getElementById("hamburgerBtn");
const mobileModal = document.getElementById("mobileModal");
const mobileModalContent = document.getElementById("mobileModalContent");
const mobileModalBox = document.getElementById("mobileModalBox");

const frontPage = document.getElementById("frontPage");
const toBookingBtn = document.getElementById("toBookingBtn");
const bookingPage = document.getElementById("bookingPage");
const calGrid = document.getElementById("calGrid");
const prevMonth = document.getElementById("prevMonth");
const nextMonth = document.getElementById("nextMonth");
const monthTitle = document.getElementById("monthTitle");
const dateInput = document.getElementById("date");
const timeInput = document.getElementById("time");
const slotsGrid = document.getElementById("slotsGrid");
const bookingForm = document.getElementById("bookingForm");
const bookingFormSection = document.getElementById("bookingFormSection");

const todayDate = document.getElementById("todayDate");
const dentistStatusEl = document.getElementById("dentistStatus");
const toastWrap = document.getElementById("toastWrap");

/* =========== App state =========== */
let displayedYear, displayedMonth;
let closedDates = {};
let slotCounts = {};
let maxSlots = 1;

const TIME_SLOTS = ["9:00 AM","9:30 AM","10:00 AM","10:30 AM","11:00 AM","11:30 AM","12:00 NN","12:30 PM","1:00 PM","1:30 PM","2:00 PM","2:30 PM","3:00 PM","3:30 PM","4:00 PM"];
const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const slotKey = s => s ? s.replace(/[^a-zA-Z0-9]/g,"_").toLowerCase() : "";

/* =========== Toast helper =========== */
function showToast(msg, type="info"){
  const el = document.createElement("div"); el.className = "toast " + type; el.textContent = msg;
  toastWrap.appendChild(el); setTimeout(()=>el.classList.add("show"),60); setTimeout(()=>el.remove(),3000);
}

/* =========== EmailJS helper =========== */
const EMAILJS_PUBLIC = "cVyQCkIy0P6hPyKrH";
const EMAILJS_SERVICE = "service_7k6q958";
const TEMPLATE_PENDING = "template_td348he";
const TEMPLATE_APPROVED = "template_7i693da";
// init once
try{ emailjs.init(EMAILJS_PUBLIC); }catch(e){console.warn("EmailJS init", e);}
function sendEmail(templateId, data){
  return emailjs.send(EMAILJS_SERVICE, templateId, data)
    .then(()=> showToast("Email sent","success"))
    .catch(err=>{ console.error("EmailJS error", err); showToast("Email failed","error"); });
}

/* =========== Firebase listeners =========== */
onValue(ref(db, "closed_dates"), snap => { closedDates = snap.exists() ? snap.val() : {}; renderCalendar(displayedYear, displayedMonth); });
onValue(ref(db, "slot_counts"), snap => { slotCounts = snap.exists() ? snap.val() : {}; renderCalendar(displayedYear, displayedMonth); });
onValue(ref(db, "settings/maxSlots"), snap => { maxSlots = snap.exists() ? snap.val() : 1; renderCalendar(displayedYear, displayedMonth); });

/* dentist status */
onValue(ref(db, "dentist_status"), snap => {
  const v = snap.exists() ? String(snap.val()).toUpperCase() : "OUT";
  dentistStatusEl.textContent = `Dentist: ${v}`;
  dentistStatusEl.classList.toggle("status-in", v === "IN");
  dentistStatusEl.classList.toggle("status-out", v !== "IN");
});

/* today date */
(function setToday(){ const d = new Date(); todayDate.textContent = d.toLocaleDateString(undefined, {weekday:"short", month:"short", day:"numeric", year:"numeric"}); })();

/* =========== Sections content (modernized) =========== */
const sections = {
  home: `<div><h3 style="margin-bottom:8px">Welcome</h3><p style="color:#334b6b">Esparagoza Dental Hub provides professional orthodontics, implants and general dentistry in Kidapawan City. Click "Make an Appointment" to start booking.</p></div>`,
  about: `<div><h3 style="margin-bottom:8px">About Us</h3><p style="color:#334b6b;line-height:1.6">Led by Dr. Jeff Esparagoza, our clinic offers compassionate, evidence-based dental care for patients of all ages. We emphasize comfort, safety, and beautiful results.</p></div>`,
  services: `<div><h3 style="margin-bottom:8px">Services</h3><ul style="line-height:1.6;color:#334b6b"><li>Pediatric Dentistry</li><li>Restorative Dentistry (Fillings)</li><li>Prosthodontics</li><li>Veneers & Crowns</li><li>Cosmetic Dentistry</li><li>Oral Surgery</li><li>Orthodontics</li></ul></div>`,
  protocols: `<div><h3 style="margin-bottom:8px">COVID-19 Dental Practice Protocols</h3>
    <p style="color:#334b6b;line-height:1.5"><b>CORONAVIRUS DISEASE 2019 (COVID-19)</b> is an infectious disease caused by severe acute respiratory syndrome coronavirus-2 (SARS-CoV-2). Common symptoms include fever, cough, fatigue, shortness of breath, and loss of smell.</p>
    <p style="color:#334b6b;line-height:1.5">The Centers for Disease Control and Prevention (CDCP) says it is primarily spread during close contact and by small droplets produced when people cough, sneeze, or talk (close contact ‚âà 1‚Äì2 meters / 3‚Äì7 ft). Dental teams are at HIGH RISK; everyone MUST follow these PROTOCOLS:</p>
    <h4 style="color:var(--brand)">General Instructions</h4>
    <ul style="line-height:1.6;color:#334b6b"><li>NO MASK, NO ENTRY</li><li>OBSERVE SOCIAL DISTANCING</li><li>ALCOHOL IS AVAILABLE FOR PATIENT'S USE</li><li>Only PATIENTS allowed inside treatment room</li><li>We discourage bringing companions except for minors and elders</li></ul>
    <h4 style="color:var(--brand)">Schedules / Appointments</h4>
    <ul style="line-height:1.6;color:#334b6b"><li><b>New Clinic Hours:</b> Monday‚ÄìSaturday, 9:00 AM ‚Äì 4:00 PM</li><li>Clinic schedule is strictly by appointment</li><li>Reschedule if you have fever or feel unwell</li></ul>
  </div>`,
  contact: `<div><h3 style="margin-bottom:8px">Contact</h3><p style="color:#334b6b;line-height:1.6">üìç Kidapawan City, North Cotabato<br>üìû 0977 780 9537<br>üìß esparagoza.jeffrey@gmail.com</p></div>`
};

/* =========== Desktop overlay behavior (floating dropdown) =========== */
let overlayTimeout = null;
function showOverlay(contentHtml, anchorEl){
  overlayCard.innerHTML = contentHtml;
  navOverlay.classList.add("show");
  navOverlay.style.pointerEvents = "auto";
  overlayCard.focus?.();
}
function hideOverlay(){
  navOverlay.classList.remove("show");
  setTimeout(()=>{ if(!navOverlay.classList.contains("show")) overlayCard.innerHTML = ""; }, 300);
  navOverlay.style.pointerEvents = "none";
}

/* attach hover for desktop nav */
document.querySelectorAll("#desktopNav a").forEach(a=>{
  const sec = a.dataset.section;
  a.addEventListener("mouseenter", ()=> {
    // highlight underline
    document.querySelectorAll("#desktopNav a").forEach(x=>x.classList.remove("active"));
    a.classList.add("active");
    showOverlay(sections[sec] || "", a);
  });
  a.addEventListener("mouseleave", ()=> {
    // small delay: if mouse goes to overlay, don't hide
    overlayTimeout = setTimeout(()=> {
      if(!navOverlay.matches(":hover")) { hideOverlay(); document.querySelectorAll("#desktopNav a").forEach(x=>x.classList.remove("active")); document.querySelector("#desktopNav a[data-section='home']").classList.add("active"); }
    }, 160);
  });
});
navOverlay.addEventListener("mouseenter", ()=>{ clearTimeout(overlayTimeout); });
navOverlay.addEventListener("mouseleave", ()=>{ hideOverlay(); document.querySelectorAll("#desktopNav a").forEach(x=>x.classList.remove("active")); document.querySelector("#desktopNav a[data-section='home']").classList.add("active"); });

/* click fallback (for accessibility & mobile) */
document.querySelectorAll("#desktopNav a").forEach(a=>{
  a.addEventListener("click", (e)=>{ e.preventDefault(); const sec = a.dataset.section; showOverlay(sections[sec] || ""); });
});

/* =========== Mobile hamburger modal (tap behavior) =========== */
hamburgerBtn.addEventListener("click", ()=>{
  mobileModalContent.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:10px">
      <button data-sec="home" class="btn-small">Home</button>
      <button data-sec="about" class="btn-small">About Us</button>
      <button data-sec="services" class="btn-small">Services</button>
      <button data-sec="protocols" class="btn-small">Protocols</button>
      <button data-sec="contact" class="btn-small">Contact</button>
      <button id="closeMobileModal" class="btn-small" style="background:linear-gradient(90deg,var(--accent),var(--brand));color:#fff">Close</button>
    </div>`;
  mobileModal.classList.add("show");
  mobileModal.style.display = "flex";

  // attach handlers
  mobileModal.querySelectorAll("[data-sec]").forEach(btn=>{
    btn.onclick = ()=> {
      const s = btn.dataset.sec;
      mobileModalContent.innerHTML = `<div>${sections[s] || ""}<div style="margin-top:16px"><button id="closeMobile2" class="btn-small" style="background:linear-gradient(90deg,var(--accent),var(--brand));color:#fff">Close</button></div></div>`;
      document.getElementById("closeMobile2").onclick = ()=> { mobileModal.classList.remove("show"); setTimeout(()=> mobileModal.style.display="none",200); };
    };
  });
  document.getElementById("closeMobileModal").onclick = ()=> { mobileModal.classList.remove("show"); setTimeout(()=> mobileModal.style.display="none",200); };
});
mobileModal.addEventListener("click", (e)=> { if(e.target === mobileModal) { mobileModal.classList.remove("show"); setTimeout(()=> mobileModal.style.display="none",200); } });

/* =========== Page transition: front -> booking (fade) =========== */
toBookingBtn.addEventListener("click", ()=>{
  frontPage.classList.add("fadeOut");
  setTimeout(()=> {
    frontPage.setAttribute("aria-hidden","true");
    bookingPage.classList.add("show");
    bookingPage.setAttribute("aria-hidden","false");
    // scroll booking page into view
    bookingPage.scrollIntoView({behavior:"smooth"});
  }, 320);
});

/* =========== Calendar logic (render) =========== */
function renderCalendar(y,m){
  const now = new Date();
  if(typeof y === "undefined"){ y = now.getFullYear(); m = now.getMonth(); }
  displayedYear = y; displayedMonth = m;
  const first = new Date(y,m,1);
  monthTitle.textContent = first.toLocaleString(undefined, {month:"long", year:"numeric"});
  calGrid.innerHTML = "";

  const start = first.getDay();
  const daysInMonth = new Date(y, m+1, 0).getDate();

  for(let i=0;i<start;i++){ const x=document.createElement("div"); x.className="day-tile other"; x.style.visibility="hidden"; calGrid.appendChild(x); }

  for(let d=1; d<=daysInMonth; d++){
    const date = new Date(y,m,d);
    const iso = fmt(date);
    const el = document.createElement("div"); el.className="day-tile"; el.textContent = d;
    const countsForDay = slotCounts[iso] || {};
    const totalBooked = Object.values(countsForDay).filter(v => v >= maxSlots).length;
    const fullyBooked = totalBooked >= TIME_SLOTS.length;

    if(closedDates[iso] || fullyBooked){ el.classList.add("closed"); el.title = closedDates[iso] ? "Closed" : "Fully booked"; }
    else if(date < new Date().setHours(0,0,0,0)){ el.style.opacity = .45; }
    else {
      el.addEventListener("click", ()=> {
        dateInput.value = iso; loadSlots(iso);
        showToast("Selected " + iso, "success");
        // auto-scroll to form section
        bookingFormSection.scrollIntoView({behavior:"smooth"});
      });
    }
    const today = new Date(); today.setHours(0,0,0,0);
    if(date.getTime() === today.getTime()) el.classList.add("today");
    calGrid.appendChild(el);
  }
}
prevMonth.addEventListener("click", ()=>{ const d = new Date(displayedYear, displayedMonth-1,1); renderCalendar(d.getFullYear(), d.getMonth()); });
nextMonth.addEventListener("click", ()=>{ const d = new Date(displayedYear, displayedMonth+1,1); renderCalendar(d.getFullYear(), d.getMonth()); });

/* =========== Load slots for a date =========== */
async function loadSlots(dateKey){
  slotsGrid.innerHTML = "";
  const snap = await get(ref(db, `slot_counts/${dateKey}`));
  const counts = snap.exists() ? snap.val() : {};
  TIME_SLOTS.forEach(slot => {
    const k = slotKey(slot);
    const c = counts[k] || 0;
    const full = c >= maxSlots;
    const btn = document.createElement("button");
    btn.className = "slot-btn";
    btn.textContent = slot + (full ? " ‚Ä¢ FULL" : "");
    if(full){ btn.classList.add("booked"); btn.disabled = true; }
    else { btn.addEventListener("click", ()=>{ timeInput.value = slot; document.querySelectorAll(".slot-btn").forEach(x=>x.classList.remove("selected")); btn.classList.add("selected"); }); }
    slotsGrid.appendChild(btn);
  });
}

/* =========== Booking submit handler =========== */
const nameEl = document.getElementById("name");
const emailEl = document.getElementById("email");
const phoneEl = document.getElementById("phone");
const serviceEl = document.getElementById("service");
const notesEl = document.getElementById("notes");

bookingForm.addEventListener("submit", async (e)=> {
  e.preventDefault();
  const name = nameEl.value.trim(), email = emailEl.value.trim(), phone = phoneEl.value.trim();
  const service = serviceEl.value, notes = notesEl.value.trim(), date = dateInput.value, time = timeInput.value;
  if(!date || !time) { showToast("Please select date and time","error"); return; }

  const key = slotKey(time);
  const slotRef = ref(db, `slot_counts/${date}/${key}`);
  try{
    const result = await runTransaction(slotRef, count => (count || 0) + 1);
    if(result.snapshot.val() > maxSlots){
      showToast("Time slot already full","error");
      // revert transaction handled above by check
      return;
    }
    const newBookingRef = push(ref(db, "bookings"));
    await set(newBookingRef, { name, email, phone, service, date, time, notes, createdAt: new Date().toISOString(), status: "pending" });
    // send pending email
    sendEmail(TEMPLATE_PENDING, { name, email, phone, service, date, time, notes });
    showToast("Booking submitted ‚Äî awaiting approval","success");
    bookingForm.reset(); timeInput.value = ""; dateInput.value = "";
    renderCalendar(displayedYear, displayedMonth);
  }catch(err){
    console.error(err);
    showToast("Booking failed","error");
  }
});

/* prevent Enter from submitting accidentally */
bookingForm.addEventListener("keydown", e => { if(e.key === "Enter") e.preventDefault(); });

/* =========== initial render =========== */
renderCalendar();
renderCalendar(new Date().getFullYear(), new Date().getMonth());

/* =========== helper: safe get =========== */
async function get(refPath){ return await getDatabaseValue(refPath); }
async function getDatabaseValue(r){ return await get(r); } // thin wrapper (keeps earlier code semantics)

/* =========== small wrapper because we used get earlier =========== */
/* Note: import `get` at top already but to avoid name collision we used wrappers. */

/* =========== finish =========== */

/* If you'd like, I can now:
  ‚Ä¢ add "Back to Home" button on booking page,
  ‚Ä¢ add small animations for CTA,
  ‚Ä¢ or produce a minified version.
*/
</script>
</body>
  </html>
