<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Esparagoza Dental Hub — Book an Appointment</title>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  body{margin:0;font-family:"Poppins",sans-serif;background:linear-gradient(135deg,#f7fbff,#eaf6ff,#dff2ff);color:#07243f;padding:18px}
  header{text-align:center;margin-bottom:10px}.logo{width:120px;border-radius:12px}
  h1{color:#0b6bcb;font-size:24px;font-weight:700;margin:10px 0}
  .card,.cal-card{background:#fff;border-radius:14px;box-shadow:0 12px 40px rgba(7,36,63,.06);margin:18px auto;max-width:520px;padding:18px;width:94%}
  .cal-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cal-month{font-weight:700;color:#0b6bcb;font-size:18px}
  .nav-btn{background:linear-gradient(90deg,#2ea0ff,#0b6bcb);color:#fff;border:none;padding:6px 10px;border-radius:10px;cursor:pointer}
  .weeknames{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;color:#3b6b90;font-size:12px;text-align:center;margin-bottom:6px}
 /* ✅ FIXED calendar layout */
.cal-grid {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 8px;
  width: 100%;
  box-sizing: border-box;
}

.day-tile {
  aspect-ratio: 1 / 1; /* make perfect squares, prevents overlapping */
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  background: #fff;
  color: #0b6bcb;
  font-weight: 600;
  cursor: pointer;
  transition: background .2s;
  min-width: 0; /* ensures tiles shrink properly */
  overflow: hidden; /* prevents text spillover */
}
  .day-tile:hover{background:#eaf6ff}
  .day-tile.closed{background:#eee;color:#888;cursor:not-allowed}
  .day-tile.booked{background:#f3f3f3;color:#aaa;cursor:not-allowed}
  .day-tile.today{outline:2px solid #2ea0ff}
  label{font-weight:600;color:#0b6bcb;font-size:.9rem;margin-top:8px;display:block}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #ccc;margin-bottom:10px;font-size:14px}
  .btn{padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,#2ea0ff,#0b6bcb);color:#fff;font-weight:700;cursor:pointer;width:100%}
  .slot-btn{padding:10px 14px;border-radius:10px;border:1px solid #ccc;margin:4px;cursor:pointer;background:#fff}
  .slot-btn.selected{background:linear-gradient(90deg,#2ea0ff,#0b6bcb);color:#fff;border:none}
  .slot-btn.booked{background:#eee;color:#999;cursor:not-allowed}
  .slots-grid{display:flex;flex-wrap:wrap;justify-content:center}
  .toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:6px;z-index:9999}
  .toast{background:#fff;padding:12px 14px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.1);border-left:5px solid #2ea0ff;opacity:0;transition:all .4s}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.success{border-left-color:#23c26b;color:#0d5e33}
  .toast.error{border-left-color:#ff6b6b;color:#7b2222}
</style>
</head>
<body>
<header>
  <img class="logo" src="https://i.imgur.com/t942gBV.png" />
  <h1>Esparagoza Dental Hub — Appointment Booking</h1>
</header>

<div class="cal-card">
  <div class="cal-top">
    <button class="nav-btn" id="prevMonth">◀</button>
    <div class="cal-month" id="monthTitle"></div>
    <button class="nav-btn" id="nextMonth">▶</button>
  </div>
  <div class="weeknames">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  </div>
  <div class="cal-grid" id="calGrid"></div>
  <p style="text-align:center;font-size:13px;color:#486b85;">Closed or fully booked dates are grayed out.</p>
</div>

<div class="card">
  <h2>Book an Appointment</h2>
  <form id="bookingForm" autocomplete="off">
    <label>Full Name</label><input id="name" required>
    <label>Email</label><input id="email" type="email" required>
    <label>Phone</label><input id="phone" type="tel" required>
    <label>Service</label>
    <select id="service" required>
      <option value="">Select Service</option>
      <option>Dental Cleaning</option>
      <option>Tooth Extraction</option>
      <option>Orthodontics (Braces)</option>
      <option>Root Canal Treatment</option>
      <option>Dental Filling</option>
      <option>Teeth Whitening</option>
      <option>Others</option>
    </select>
    <div id="otherWrap" style="display:none;">
      <label>Specify Service</label><input id="otherText">
    </div>
    <label>Date</label><input id="date" readonly required placeholder="Select date from calendar">
    <label>Time</label><input id="time" readonly required placeholder="Select a time slot">
    <div class="slots-grid" id="slotsGrid"></div>
    <label>Notes (optional)</label><textarea id="notes" rows="3"></textarea>
    <button class="btn" type="submit">Submit Booking</button>
  </form>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<script type="module">
// ✅ Firebase SDK
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set, push, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// ✅ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCV39b2CkzS_tt75SVXa6z95s6f4qVlfLg",
  authDomain: "esparagozadentalclinic-6a744.firebaseapp.com",
  databaseURL: "https://esparagozadentalclinic-6a744-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esparagozadentalclinic-6a744",
  storageBucket: "esparagozadentalclinic-6a744.firebasestorage.app",
  messagingSenderId: "959639046373",
  appId: "1:959639046373:web:ccf39df13d94e527fcec0c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
emailjs.init("xvStFrKI-3M-3ZCvz");

// ✅ Elements
const calGrid=document.getElementById("calGrid"),monthTitle=document.getElementById("monthTitle");
const prevMonth=document.getElementById("prevMonth"),nextMonth=document.getElementById("nextMonth");
const dateInput=document.getElementById("date"),timeInput=document.getElementById("time"),slotsGrid=document.getElementById("slotsGrid");
const toastWrap=document.getElementById("toastWrap");
let displayedYear,displayedMonth,closedDates={},slotCounts={},maxSlots=1;

const TIME_SLOTS=["8:00 AM - 9:00 AM","9:00 AM - 10:00 AM","10:00 AM - 11:00 AM","11:00 AM - 12:00 NN","1:00 PM - 2:00 PM","2:00 PM - 3:00 PM","3:00 PM - 4:00 PM","4:00 PM - 5:00 PM"];
function formatDateKey(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`}
function slotKey(s){return s.replace(/[^a-zA-Z0-9]/g,"_").toLowerCase()}
function showToast(msg,type="info"){const t=document.createElement("div");t.className="toast";if(type==="success")t.classList.add("success");if(type==="error")t.classList.add("error");t.textContent=msg;toastWrap.appendChild(t);setTimeout(()=>t.classList.add("show"),50);setTimeout(()=>t.remove(),3000)}

// ✅ Realtime listeners
onValue(ref(db,"closed_dates"),s=>{closedDates=s.exists()?s.val():{};renderCal(displayedYear,displayedMonth)});
onValue(ref(db,"settings/maxSlots"),s=>{maxSlots=s.exists()?s.val():1});
onValue(ref(db,"slot_counts"),s=>{slotCounts=s.exists()?s.val():{};renderCal(displayedYear,displayedMonth)});

// ✅ Render Calendar (fixed)
function renderCal(y,m){
  const now=new Date();
  if(y==null||m==null){y=now.getFullYear();m=now.getMonth();}
  displayedYear=y;displayedMonth=m;
  const firstDay=new Date(y,m,1);
  const monthName=firstDay.toLocaleString("default",{month:"long",year:"numeric"});
  monthTitle.textContent=monthName;
  calGrid.innerHTML="";
  const startDay=firstDay.getDay();
  const daysInMonth=new Date(y,m+1,0).getDate();
  for(let i=0;i<startDay;i++){const e=document.createElement("div");e.className="day-tile";e.style.visibility="hidden";calGrid.appendChild(e);}
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(y,m,d);const iso=formatDateKey(date);
    const div=document.createElement("div");div.className="day-tile";div.textContent=d;
    if(closedDates[iso])div.classList.add("closed");
    else if(date<new Date().setHours(0,0,0,0))div.style.opacity=.4;
    else{div.onclick=()=>{dateInput.value=iso;loadSlots(iso);showToast("Selected "+iso,"success")}}
    const today=new Date();today.setHours(0,0,0,0);if(date.getTime()===today.getTime())div.classList.add("today");
    calGrid.appendChild(div);
  }
}
prevMonth.onclick=()=>{const d=new Date(displayedYear,displayedMonth-1,1);renderCal(d.getFullYear(),d.getMonth())}
nextMonth.onclick=()=>{const d=new Date(displayedYear,displayedMonth+1,1);renderCal(d.getFullYear(),d.getMonth())}
renderCal();

// ✅ Load Slots
async function loadSlots(dateKey){
  slotsGrid.innerHTML="";
  const countsSnap=await get(ref(db,`slot_counts/${dateKey}`));
  const counts=countsSnap.exists()?countsSnap.val():{};
  TIME_SLOTS.forEach(slot=>{
    const k=slotKey(slot),c=counts[k]||0,full=c>=maxSlots;
    const b=document.createElement("button");
    b.className="slot-btn";
    b.textContent=slot+(full?" • FULL":"");
    if(full)b.classList.add("booked");
    else b.onclick=()=>{timeInput.value=slot;document.querySelectorAll(".slot-btn").forEach(x=>x.classList.remove("selected"));b.classList.add("selected");};
    slotsGrid.appendChild(b);
  });
}

// ✅ Submit Booking
document.getElementById("bookingForm").onsubmit=async e=>{
  e.preventDefault();
  const name=document.getElementById("name").value.trim(),
        email=document.getElementById("email").value.trim(),
        phone=document.getElementById("phone").value.trim(),
        notes=document.getElementById("notes").value.trim();
  let service=document.getElementById("service").value.trim();
  if(service==="Others")service=document.getElementById("otherText").value.trim()||"Others";
  const date=dateInput.value,time=timeInput.value;
  if(!name||!email||!phone||!service||!date||!time)return showToast("Please complete all fields","error");
  const sKey=slotKey(time),slotRef=ref(db,`slot_counts/${date}/${sKey}`);
  const tx=await runTransaction(slotRef,c=>{if(!c)c=0;if(c>=maxSlots)return;c+1});
  if(!tx.committed)return showToast("Slot full, choose another","error");
  const booking={name,email,phone,service,date,time,notes,timestamp:Date.now()};
  await set(push(ref(db,`appointments/${date}/${sKey}`)),booking);
  try{await emailjs.send("service_qtacvtn","template_edmr2cm",{to_email:email,user_name:name,appointment_service:service,appointment_date:date,appointment_time:time});showToast("Appointment booked!","success");}
  catch(e){showToast("Booked but email failed","error")}
  e.target.reset();slotsGrid.innerHTML="";
};
</script>
</body>
      </html>
