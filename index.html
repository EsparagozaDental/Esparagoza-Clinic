<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Esparagoza Dental Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<style>
  :root{
    --brand:#0b6bcb;
    --accent:#2ea0ff;
    --success:#00b386;
    --danger:#d9534f;
    --card-bg: #ffffff;
    --muted:#999;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
  html,body{height:100%}
  body{
    background:linear-gradient(180deg,#e9f4ff 0%,#f4f9ff 100%);
    min-height:100vh;overflow-x:hidden;color:var(--brand);
  }

  .app { position:relative; min-height:100vh; display:flex; align-items:stretch; justify-content:center; }

  /* FRONT PAGE */
  #frontPage{
    position:fixed;inset:0;
    background-image: url('https://i.imgur.com/EHVhWYb.jpeg');
    background-size:cover;background-position:center;
    display:flex;align-items:center;justify-content:center;
    z-index:40;
    transition:opacity .6s ease, transform .6s ease;
  }
  #frontPage.dim{opacity:0;pointer-events:none;transform:scale(1.03);}

  .front-overlay{ position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(255,255,255,0.08));backdrop-filter: blur(1px); }

  .front-inner{
    position:relative;z-index:2;max-width:920px;width:92%;text-align:center;padding:36px;border-radius:14px;
    color:#fff;display:flex;flex-direction:column;align-items:center;gap:12px;
  }
  .logo-big{width:140px;height:auto;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.25)}
  .welcome{font-size:28px;font-weight:700;color:#fff;text-shadow:0 3px 14px rgba(0,0,0,0.4)}
  .muted-white{color:rgba(255,255,255,0.9);font-weight:600}
  .meta-row{display:flex;gap:14px;align-items:center;flex-wrap:wrap;justify-content:center}
  .pill{background:rgba(255,255,255,0.12);padding:10px 14px;border-radius:999px;font-weight:700;color:#fff}
  .status-in{background:linear-gradient(90deg,#67e3a1,#00b386);color:#053017}
  .status-out{background:linear-gradient(90deg,#ffdede,#ff8a8a);color:#4a0b0b}
  .cta-btn{margin-top:12px;padding:14px 22px;border-radius:12px;border:none;font-weight:700;background:linear-gradient(90deg,var(--accent),var(--brand));color:#fff;cursor:pointer;box-shadow:0 8px 26px rgba(11,107,203,0.24);transition:transform .16s ease}
  .cta-btn:active{transform:translateY(1px) scale(.997)}

  /* FRONT PAGE top-right nav (desktop links or mobile hamburger) */
  .front-top {
    position:absolute;top:16px;right:16px;z-index:60;display:flex;align-items:center;gap:10px;
  }
  .nav-links{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,0.06);padding:8px;border-radius:10px}
  .nav-links a{color:#fff;text-decoration:none;font-weight:700;padding:6px 10px;border-radius:8px}
  .nav-links a:hover{background:rgba(255,255,255,0.08)}
  .menu-btn{background:linear-gradient(90deg,var(--accent),var(--brand));color:#fff;border:none;padding:8px 10px;border-radius:10px;font-size:18px;cursor:pointer}

  /* Media: on mobile show hamburger, hide desktop nav; on desktop show nav, hide hamburger */
  @media(max-width:900px){
    .nav-links{display:none}
    .menu-btn{display:inline-flex}
  }
  @media(min-width:901px){
    .menu-btn{display:none}
    .nav-links{display:flex}
  }

  /* BOOKING PAGE (hidden initially) */
  #bookingPage{ position:relative;max-width:980px;width:100%;padding:28px 20px;margin:36px auto 80px;opacity:0;transform:translateY(12px);transition:opacity .6s ease, transform .6s ease;z-index:10;}
  #bookingPage.show{opacity:1;transform:translateY(0);}

  /* Card & form styles */
  .card{background:var(--card-bg);border-radius:16px;box-shadow:0 10px 30px rgba(7,36,63,.08);padding:22px;margin:18px auto;max-width:520px}
  label{display:block;margin:8px 0 4px;color:var(--brand);font-weight:600}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid #d5e6f7;border-radius:10px;font-size:15px;outline:none}
  .btn-primary{cursor:pointer;transition:.3s;background:linear-gradient(90deg,var(--accent),var(--brand));color:#fff;border:none;border-radius:10px;padding:12px 18px;font-weight:700;width:100%}

  /* Calendar */
  .weeknames{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;color:#3b6b90;font-size:12px;text-align:center;margin-bottom:6px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;width:100%}
  .day-tile{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#fff;color:var(--brand);font-weight:600;cursor:pointer;transition:background .2s;min-width:0;overflow:hidden}
  .day-tile.today{border:2px solid var(--brand)}
  .day-tile.closed{background:#e0e0e0;color:var(--muted);cursor:not-allowed}

  .slot-btn{padding:10px;border:none;border-radius:8px;margin:4px;background:#e7f1ff;color:var(--brand);font-weight:600}
  .slot-btn.selected{background:var(--brand);color:#fff}
  .slot-btn.booked{background:#ccc;color:#666;cursor:not-allowed}

  /* Toast */
  .toast-wrap{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:1000}
  .toast{background:var(--brand);color:#fff;padding:10px 16px;border-radius:8px;margin-top:8px;opacity:0;transition:opacity .3s}
  .toast.show{opacity:1}
  .toast.success{background:var(--success)}
  .toast.error{background:var(--danger)}

  /* Modal */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);backdrop-filter:blur(3px);justify-content:center;align-items:center;z-index:1001}
  .modal-content{background:#fff;border-radius:16px;max-width:420px;width:90%;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.15);color:var(--brand);max-height:80vh;overflow-y:auto}
  .close-btn{position:absolute;top:12px;right:16px;background:var(--brand);color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;font-weight:bold;cursor:pointer}

  .text-center{text-align:center}
  .muted{color:#5b7b9a}
</style>
</head>
<body>
<div class="app">

  <!-- FRONT PAGE -->
  <section id="frontPage" aria-hidden="false">
    <div class="front-overlay"></div>

    <!-- TOP-RIGHT NAV / HAMBURGER (now on FRONT PAGE only) -->
    <div class="front-top">
      <nav class="nav-links" id="desktopNav">
        <a href="#" data-section="about">About Us</a>
        <a href="#" data-section="services">Services</a>
        <a href="#" data-section="protocols">Protocols</a>
        <a href="#" data-section="contact">Contact</a>
      </nav>
      <button class="menu-btn" id="menuBtn" aria-label="Open menu">&#9776;</button>
    </div>

    <div class="front-inner">
      <img src="https://i.imgur.com/t942gBV.png" class="logo-big" alt="logo">
      <div class="welcome">Welcome to Esparagoza Dental Clinic</div>
      <div class="meta-row">
        <div class="pill muted-white" id="todayDate">Today</div>
        <div class="pill muted-white" id="dentistStatus">Dentist: ...</div>
      </div>
      <button class="cta-btn" id="toBookingBtn">Make an Appointment</button>
      <div style="margin-top:8px;color:rgba(255,255,255,0.92);font-weight:600">Tap to schedule your visit</div>
    </div>
  </section>

  <!-- BOOKING PAGE (no topbar/menu here) -->
  <main id="bookingPage" aria-hidden="true">
    <div class="cal-card card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <button class="btn-primary" id="prevMonth" style="width:48px">&#10094;</button>
        <div style="font-weight:700;color:var(--brand);font-size:18px" id="monthTitle">Month</div>
        <button class="btn-primary" id="nextMonth" style="width:48px">&#10095;</button>
      </div>
      <div class="weeknames"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
      <div class="cal-grid" id="calGrid"></div>
      <p style="text-align:center;font-size:12px;margin-top:6px;color:#3b6b90">Closed or fully booked dates are grayed out.</p>
    </div>

    <section class="card" style="margin-top:16px;">
      <h2 style="color:var(--brand);margin-bottom:10px">Book an Appointment</h2>
      <form id="bookingForm">
        <label>Full Name</label><input type="text" id="name" placeholder="Enter full name" required>
        <label>Email</label><input type="email" id="email" placeholder="Enter email" required>
        <label>Phone</label><input type="text" id="phone" placeholder="Enter phone" required>
        <label>Service</label>
        <select id="service" required>
          <option value="">Select Service</option>
          <option>Pediatric Dentistry</option>
          <option>Restorative Dentistry (Tooth Filling)</option>
          <option>Prosthodontics</option>
          <option>Veneers Dental Crown</option>
          <option>Cosmetic Dentistry</option>
          <option>Oral Surgery</option>
          <option>Orthodontics</option>
        </select>
        <label>Date</label><input type="text" id="date" readonly placeholder="Select date from calendar" required>
        <label>Time</label><input type="text" id="time" readonly placeholder="Select a time slot" required>
        <div id="slotsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px;margin:10px 0;"></div>
        <label>Notes (optional)</label><textarea id="notes" rows="2" placeholder="Additional notes"></textarea>
        <button class="btn-primary" type="submit">Submit Booking</button>
      </form>
    </section>
  </main>

  <div class="toast-wrap" id="toastWrap"></div>

  <!-- Modal (shared for desktop nav & mobile menu) -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent" style="position:relative">
      <button class="close-btn" id="closeModal" aria-label="Close">&times;</button>
      <div id="modalMenu">
        <h3 style="text-align:center;">Esparagoza Dental Hub</h3>
        <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
          <button class="modal-link" data-section="about" style="background:rgba(11,107,203,0.08);padding:12px;border-radius:10px;border:none;font-weight:700">About Us</button>
          <button class="modal-link" data-section="services" style="background:rgba(11,107,203,0.08);padding:12px;border-radius:10px;border:none;font-weight:700">Services</button>
          <button class="modal-link" data-section="protocols" style="background:rgba(11,107,203,0.08);padding:12px;border-radius:10px;border:none;font-weight:700">Protocols</button>
          <button class="modal-link" data-section="contact" style="background:rgba(11,107,203,0.08);padding:12px;border-radius:10px;border:none;font-weight:700">Contact</button>
        </div>
      </div>
      <div id="sectionContent" style="display:none;margin-top:16px"></div>
    </div>
  </div>

  <script type="module">
/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set, push, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyCV39b2CkzS_tt75SVXa6z95s6f4qVlfLg",
  authDomain: "esparagozadentalclinic-6a744.firebaseapp.com",
  databaseURL: "https://esparagozadentalclinic-6a744-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esparagozadentalclinic-6a744",
  storageBucket: "esparagozadentalclinic-6a744.firebasestorage.app",
  messagingSenderId: "959639046373",
  appId: "1:959639046373:web:ccf39df13d94e527fcec0c"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* DOM */
const frontPage = document.getElementById("frontPage");
const toBookingBtn = document.getElementById("toBookingBtn");
const bookingPage = document.getElementById("bookingPage");
const monthTitle = document.getElementById("monthTitle");
const calGrid = document.getElementById("calGrid");
const prevMonth = document.getElementById("prevMonth");
const nextMonth = document.getElementById("nextMonth");
const dateInput = document.getElementById("date");
const timeInput = document.getElementById("time");
const slotsGrid = document.getElementById("slotsGrid");
const toastWrap = document.getElementById("toastWrap");
const menuBtn = document.getElementById("menuBtn");
const modalOverlay = document.getElementById("modalOverlay");
const modalContent = document.getElementById("modalContent");
const closeModal = document.getElementById("closeModal");
const sectionContent = document.getElementById("sectionContent");
const desktopNav = document.getElementById("desktopNav");
const todayDate = document.getElementById("todayDate");
const dentistStatusEl = document.getElementById("dentistStatus");

let displayedYear, displayedMonth;
let closedDates = {};
let slotCounts = {};
let maxSlots = 1;

const TIME_SLOTS = [
  "9:00 AM","9:30 AM","10:00 AM","10:30 AM","11:00 AM","11:30 AM",
  "12:00 NN","12:30 PM","1:00 PM","1:30 PM","2:00 PM","2:30 PM","3:00 PM","3:30 PM","4:00 PM"
];

const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
const slotKey = s => s.replace(/[^a-zA-Z0-9]/g,"_").toLowerCase();

function showToast(msg, type="info") {
  const el = document.createElement("div");
  el.className = "toast " + type;
  el.textContent = msg;
  toastWrap.appendChild(el);
  setTimeout(()=>el.classList.add("show"), 50);
  setTimeout(()=>el.remove(), 3000);
}

/* ==== Firebase listeners for dates/slots/settings ==== */
onValue(ref(db, "closed_dates"), s => { closedDates = s.exists() ? s.val() : {}; renderCalendar(); });
onValue(ref(db, "settings/maxSlots"), s => { maxSlots = s.exists() ? s.val() : 1; });
onValue(ref(db, "slot_counts"), s => { slotCounts = s.exists() ? s.val() : {}; renderCalendar(); });

/* Dentist IN/OUT -- listens for a simple key dentist_status (value "IN" or "OUT") */
onValue(ref(db, "dentist_status"), s => {
  const v = s.exists() ? String(s.val()).toUpperCase() : "OUT";
  dentistStatusEl.textContent = `Dentist: ${v}`;
  dentistStatusEl.classList.toggle("status-in", v === "IN");
  dentistStatusEl.classList.toggle("status-out", v !== "IN");
});

/* Today date */
(function updateToday(){
  const d = new Date();
  todayDate.textContent = d.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric", year: "numeric" });
})();

/* ==== EmailJS helper (your provided keys) ==== */
function sendEmail(templateId, bookingData) {
  emailjs.init("cVyQCkIy0P6hPyKrH"); // your public key
  return emailjs.send("service_7k6q958", templateId, bookingData)
    .then(() => {
      console.log("‚úÖ Email sent:", templateId);
      showToast("Confirmation email sent!", "success");
    })
    .catch(err => {
      console.error("‚ùå Email failed:", err);
      showToast("Email not sent.", "error");
    });
}

/* ==== Calendar render ==== */
function renderCalendar(y, m) {
  const now = new Date();
  if (!y && !m) { y = now.getFullYear(); m = now.getMonth(); }
  displayedYear = y; displayedMonth = m;
  const first = new Date(y, m, 1);
  monthTitle.textContent = first.toLocaleString("default", { month: "long", year: "numeric" });
  calGrid.innerHTML = "";

  const start = first.getDay();
  const daysInMonth = new Date(y, m + 1, 0).getDate();

  for (let i = 0; i < start; i++) {
    const e = document.createElement("div");
    e.className = "day-tile";
    e.style.visibility = "hidden";
    calGrid.appendChild(e);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(y, m, d);
    const iso = fmt(date);
    const div = document.createElement("div");
    div.className = "day-tile";
    div.textContent = d;

    const countsForDay = slotCounts[iso] || {};
    const totalBooked = Object.values(countsForDay).filter(v => v >= maxSlots).length;
    const fullyBooked = totalBooked >= TIME_SLOTS.length;

    if (closedDates[iso] || fullyBooked) {
      div.classList.add("closed");
      div.title = fullyBooked ? "Fully booked" : "Closed";
    } else if (date < new Date().setHours(0, 0, 0, 0)) {
      div.style.opacity = .4;
    } else {
      div.onclick = () => {
        dateInput.value = iso;
        loadSlots(iso);
        showToast("Selected " + iso, "success");
      };
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    if (date.getTime() === today.getTime()) div.classList.add("today");
    calGrid.appendChild(div);
  }
}

prevMonth.onclick = () => { const d = new Date(displayedYear, displayedMonth - 1, 1); renderCalendar(d.getFullYear(), d.getMonth()); };
nextMonth.onclick = () => { const d = new Date(displayedYear, displayedMonth + 1, 1); renderCalendar(d.getFullYear(), d.getMonth()); };
renderCalendar();

/* ==== Load time slots for a date ==== */
async function loadSlots(dateKey) {
  slotsGrid.innerHTML = "";
  const cSnap = await get(ref(db, `slot_counts/${dateKey}`));
  const counts = cSnap.exists() ? cSnap.val() : {};
  TIME_SLOTS.forEach(slot => {
    const k = slotKey(slot);
    const c = counts[k] || 0;
    const full = c >= maxSlots;
    const b = document.createElement("button");
    b.className = "slot-btn";
    b.textContent = slot + (full ? " ‚Ä¢ FULL" : "");
    if (full) b.classList.add("booked");
    else b.onclick = () => {
      timeInput.value = slot;
      document.querySelectorAll(".slot-btn").forEach(x => x.classList.remove("selected"));
      b.classList.add("selected");
    };
    slotsGrid.appendChild(b);
  });
}

/* ==== Booking submit ==== */
document.getElementById("bookingForm").onsubmit = async e => {
  e.preventDefault();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const notes = document.getElementById("notes").value.trim();
  const service = document.getElementById("service").value;
  const date = dateInput.value;
  const time = timeInput.value;
  if (!date || !time) return showToast("Select date & time!", "error");

  const key = slotKey(time);
  const slotRef = ref(db, `slot_counts/${date}/${key}`);

  try {
    const booked = await runTransaction(slotRef, count => (count || 0) + 1);
    if (booked.snapshot.val() > maxSlots) {
      showToast("Time slot already full!", "error");
      return;
    }

    const newRef = push(ref(db, "bookings"));
    await set(newRef, {
      name, email, phone, service, date, time, notes,
      createdAt: new Date().toISOString()
    });

    // send pending email using your pending template id
    sendEmail("template_td348he", { name, email, phone, service, date, time, notes });

    showToast("Booking successful!", "success");
    e.target.reset();
    timeInput.value = "";
    renderCalendar(displayedYear, displayedMonth);
  } catch (err) {
    console.error(err);
    showToast("Booking failed!", "error");
  }
};

/* Prevent accidental Enter key submit */
document.getElementById("bookingForm").addEventListener("keydown", function(e) {
  if (e.key === "Enter") e.preventDefault();
});

/* ==== Page transition: fade (Option 1) ==== */
toBookingBtn.addEventListener("click", () => {
  // fade front page, then show booking page
  frontPage.classList.add("dim");
  setTimeout(() => {
    frontPage.setAttribute("aria-hidden","true");
    bookingPage.classList.add("show");
    bookingPage.setAttribute("aria-hidden","false");
    bookingPage.scrollIntoView({behavior:"smooth"});
  }, 320);
});

/* ==== Modal & menu behavior ==== */
menuBtn.addEventListener("click", () => {
  modalOverlay.style.display = "flex";
  modalContent.scrollTop = 0;
});
closeModal.addEventListener("click", () => modalOverlay.style.display = "none");
modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) modalOverlay.style.display = "none"; });

/* Desktop nav links open modal too */
document.querySelectorAll('#desktopNav a').forEach(a=>{
  a.addEventListener('click', (ev) => { ev.preventDefault(); const sec = a.dataset.section; openSection(sec); });
});

/* Modal internal links */
document.querySelectorAll('.modal-link').forEach(btn=>{
  btn.addEventListener('click', () => { openSection(btn.dataset.section); });
});

/* When front-page logo (center) is clicked, do nothing; clicking front-top logo is not present.
   Allow booking page to return to front page via small UX: double tap logo in booking page? 
   For now we keep a simple approach: reload to front via history/back or you can add a 'Back to Home' if desired. */

/* openSection helper: loads the content into modal and shows it */
function openSection(sec){
  const contentMap = {
    about: `
      <div style="text-align:center;">
        <img src="https://i.imgur.com/t942gBV.png" style="width:80px;margin-bottom:10px" alt="logo">
        <h3>About Us</h3>
        <p><b>Orthodontics, Implant & General Dentistry</b></p>
        <p>Dr. Jeff Esparagoza provides dental services such as orthodontics, implant, and general dentistry.</p>
      </div>
    `,
    services: `
      <div style="text-align:center;">
        <h3>Our Dental Services</h3>
        <ul style="margin-top:10px;line-height:1.8;list-style:none;padding:0;">
          <li>Pediatric Dentistry ‚Äî 30 minutes</li>
          <li>Restorative Dentistry (Tooth Filling) ‚Äî 30 minutes</li>
          <li>Prosthodontics ‚Äî 30 minutes</li>
          <li>Veneers Dental Crown ‚Äî 30 minutes</li>
          <li>Cosmetic Dentistry ‚Äî 30 minutes</li>
          <li>Oral Surgery ‚Äî 30 minutes</li>
          <li>Orthodontics ‚Äî 30 minutes</li>
        </ul>
      </div>
    `,
    protocols: `
      <div style="text-align:center;">
        <h3>Protocols</h3>
        <ul style="margin-top:10px;line-height:1.8;list-style:none;padding:0;">
          <li>NO MASK, NO ENTRY</li>
          <li>OBSERVE SOCIAL DISTANCING</li>
          <li>ALCOHOL AVAILABLE FOR PATIENT USE</li>
          <li>ONLY PATIENTS ALLOWED INSIDE TREATMENT ROOM</li>
          <li>NO COMPANIONS EXCEPT MINORS/ELDERS</li>
        </ul>
      </div>
    `,
    contact: `
      <div style="text-align:center;">
        <h3>Contact Us</h3>
        <p>üìç Kidapawan City, North Cotabato, Philippines</p>
        <p>üìû 0977 780 9537</p>
        <p>üìß esparagoza.jeffrey@gmail.com</p>
      </div>
    `
  };
  sectionContent.innerHTML = contentMap[sec] || "";
  modalOverlay.style.display = "flex";
}

/* Close modal on Escape key */
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') modalOverlay.style.display = 'none'; });

</script>
</div>
</body>
  </html>
