<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Esparagoza Dental Hub ‚Äî Appointment Booking</title>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  body{margin:0;font-family:"Poppins",sans-serif;background:linear-gradient(135deg,#f7fbff,#eaf6ff,#dff2ff);color:#07243f;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .logo{width:100px;border-radius:12px}
  .menu-btn{background:none;border:none;font-size:26px;color:#0b6bcb;cursor:pointer}
  h1{color:#0b6bcb;font-size:20px;font-weight:700;margin:10px 0;text-align:left}

  /* Cards */
  .card,.cal-card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(7,36,63,0.08);
    margin:18px auto;padding:22px;max-width:480px;width:calc(100% - 30px);box-sizing:border-box;}
  @media(max-width:480px){.card,.cal-card{max-width:340px;width:90%;padding:16px}}

  /* Calendar */
  .cal-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cal-month{font-weight:700;color:#0b6bcb;font-size:18px}
  .nav-btn{background:linear-gradient(90deg,#2ea0ff,#0b6bcb);color:#fff;border:none;padding:6px 10px;border-radius:10px;cursor:pointer}
  .weeknames{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;color:#3b6b90;font-size:12px;text-align:center;margin-bottom:6px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:6px;width:100%}
  .day-tile{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#fff;color:#0b6bcb;font-weight:600;cursor:pointer;transition:background .2s;min-width:0;overflow:hidden}
  .day-tile:hover{background:#eaf6ff}
  .day-tile.closed{background:#eee;color:#888;cursor:not-allowed}
  .day-tile.booked{background:#f3f3f3;color:#aaa;cursor:not-allowed}
  .day-tile.today{outline:2px solid #2ea0ff}

  label{font-weight:600;color:#0b6bcb;font-size:.9rem;margin-top:8px;display:block}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #ccc;margin-bottom:10px;font-size:14px}
  .btn{padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,#2ea0ff,#0b6bcb);color:#fff;font-weight:700;cursor:pointer;width:100%}

  /* Time slots */
  .slots-grid{display:flex;flex-wrap:wrap;justify-content:center;gap:6px}
  .slot-btn{padding:8px 14px;border-radius:20px;border:2px solid #0b6bcb;background:#fff;color:#0b6bcb;font-weight:600;cursor:pointer;transition:all .25s;}
  .slot-btn:hover{background:#eaf6ff}
  .slot-btn.selected{background:linear-gradient(90deg,#2ea0ff,#0b6bcb);color:#fff;border:none}
  .slot-btn.booked{background:#f3f3f3;color:#999;border-color:#ccc;cursor:not-allowed}

  /* Toasts */
  .toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:6px;z-index:9999}
  .toast{background:#fff;padding:12px 14px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.1);border-left:5px solid #2ea0ff;opacity:0;transition:all .4s}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.success{border-left-color:#23c26b;color:#0d5e33}
  .toast.error{border-left-color:#ff6b6b;color:#7b2222}

  /* üîπ Modal menu */
  .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);
    backdrop-filter:blur(3px);display:none;justify-content:center;align-items:center;z-index:10000;}
  .modal-content{background:#fff;border-radius:18px;max-width:500px;width:90%;max-height:85vh;overflow-y:auto;
    padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.2);animation:fadeIn .3s ease;position:relative;}
  @keyframes fadeIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
  .fade-up{animation:fadeUp .6s ease;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
  .close-btn{position:absolute;top:14px;right:20px;font-size:24px;color:#0b6bcb;background:none;border:none;cursor:pointer}
  .modal-content h3{text-align:center;color:#0b6bcb;margin-top:10px}
  .modal-content p,.modal-content li{font-size:14px;line-height:1.5;color:#07243f;margin-bottom:10px;text-align:justify;}
  .modal-content ul{padding-left:20px;margin:0}
  .modal-logo{display:block;margin:0 auto 10px auto;width:110px;border-radius:12px;}
  .menu-options{display:flex;flex-direction:column;gap:10px;margin-top:20px;}
  .menu-tile{background:rgba(11,107,203,0.15);color:#0b6bcb;border:none;padding:14px;border-radius:10px;
    font-weight:600;cursor:pointer;transition:all .3s;}
  .menu-tile:hover{background:rgba(11,107,203,0.25);}
  .line{height:2px;background:#0b6bcb;width:100%;border-radius:2px;}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <img class="logo" src="https://i.imgur.com/t942gBV.png" />
    <h1>Esparagoza Dental Hub</h1>
  </div>
  <button class="menu-btn" id="menuBtn">‚ò∞</button>
</header>

<!-- Calendar -->
<div class="cal-card">
  <div class="cal-top">
    <button class="nav-btn" id="prevMonth">‚óÄ</button>
    <div class="cal-month" id="monthTitle"></div>
    <button class="nav-btn" id="nextMonth">‚ñ∂</button>
  </div>
  <div class="weeknames">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  </div>
  <div class="cal-grid" id="calGrid"></div>
  <p style="text-align:center;font-size:13px;color:#486b85;">Closed or fully booked dates are grayed out.</p>
</div>

<!-- Booking Form -->
<div class="card">
  <h2>Book an Appointment</h2>
  <form id="bookingForm" autocomplete="off">
    <label>Full Name</label><input id="name" required>
    <label>Email</label><input id="email" type="email" required>
    <label>Phone</label><input id="phone" type="tel" required>
    <label>Service</label>
    <select id="service" required>
      <option value="">Select Service</option>
      <option>Pediatric Dentistry</option>
      <option>Restorative Dentistry (Tooth Filling)</option>
      <option>Prosthodontics</option>
      <option>Veneers Dental Crown</option>
      <option>Cosmetic Dentistry</option>
      <option>Oral Surgery</option>
      <option>Orthodontics</option>
    </select>
    <label>Date</label><input id="date" readonly required placeholder="Select date from calendar">
    <label>Time</label><input id="time" readonly required placeholder="Select a time slot">
    <div class="slots-grid" id="slotsGrid"></div>
    <label>Notes (optional)</label><textarea id="notes" rows="3"></textarea>
    <button class="btn" type="submit">Submit Booking</button>
  </form>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<!-- üîπ Modern Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content fade-up" id="modalContent">
    <button class="close-btn" id="closeModal">&times;</button>

    <!-- Menu Selector -->
    <div id="modalMenu" class="fade-up">
      <h3>Esparagoza Dental Hub</h3>
      <div class="menu-options">
        <button class="menu-tile" data-section="about">About Us</button>
        <div class="line"></div>
        <button class="menu-tile" data-section="services">Services</button>
        <div class="line"></div>
        <button class="menu-tile" data-section="protocols">Protocols</button>
        <div class="line"></div>
        <button class="menu-tile" data-section="contact">Contact Us</button>
      </div>
    </div>

    <!-- Section Details -->
    <div id="sectionContent" style="display:none;">
      <button id="backBtn" style="background:none;border:none;color:#0b6bcb;font-weight:700;margin-bottom:10px;cursor:pointer;">‚Üê Back</button>
      <div id="sectionBody"></div>
    </div>
  </div>
  </div>

  <script type="module">
/* ------------------------- FIREBASE CONFIG ------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, get, set, push, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* Replace this config with yours if needed */
const firebaseConfig = {
  apiKey: "AIzaSyCV39b2CkzS_tt75SVXa6z95s6f4qVlfLg",
  authDomain: "esparagozadentalclinic-6a744.firebaseapp.com",
  databaseURL: "https://esparagozadentalclinic-6a744-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "esparagozadentalclinic-6a744",
  storageBucket: "esparagozadentalclinic-6a744.firebasestorage.app",
  messagingSenderId: "959639046373",
  appId: "1:959639046373:web:ccf39df13d94e527fcec0c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Initialize EmailJS */
emailjs.init("xvStFrKI-3M-3ZCvz");

/* ------------------------- GLOBAL VARIABLES ------------------------- */
const calGrid = document.getElementById("calGrid");
const monthTitle = document.getElementById("monthTitle");
const prevMonth = document.getElementById("prevMonth");
const nextMonth = document.getElementById("nextMonth");
const dateInput = document.getElementById("date");
const timeInput = document.getElementById("time");
const slotsGrid = document.getElementById("slotsGrid");
const toastWrap = document.getElementById("toastWrap");

let displayedYear, displayedMonth;
let closedDates = {};
let slotCounts = {};
let maxSlots = 1;

const TIME_SLOTS = [
  "9:00 AM", "9:30 AM", "10:00 AM", "10:30 AM", "11:00 AM", "11:30 AM",
  "12:00 NN", "12:30 PM", "1:00 PM", "1:30 PM", "2:00 PM", "2:30 PM",
  "3:00 PM", "3:30 PM", "4:00 PM"
];

/* ------------------------- HELPERS ------------------------- */
function formatDateKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function slotKey(s) {
  return s.replace(/[^a-zA-Z0-9]/g, "_").toLowerCase();
}
function showToast(msg, type="info") {
  const t = document.createElement("div");
  t.className = "toast";
  if (type==="success") t.classList.add("success");
  if (type==="error") t.classList.add("error");
  t.textContent = msg;
  toastWrap.appendChild(t);
  setTimeout(() => t.classList.add("show"), 50);
  setTimeout(() => t.remove(), 3000);
}

/* ------------------------- FIREBASE SYNC ------------------------- */
onValue(ref(db,"closed_dates"), s => {
  closedDates = s.exists()?s.val():{};
  renderCal(displayedYear, displayedMonth);
});
onValue(ref(db,"settings/maxSlots"), s => {
  maxSlots = s.exists()?s.val():1;
});
onValue(ref(db,"slot_counts"), s => {
  slotCounts = s.exists()?s.val():{};
  renderCal(displayedYear, displayedMonth);
});

/* ------------------------- CALENDAR ------------------------- */
function renderCal(y, m) {
  const now = new Date();
  if (y == null || m == null) { y = now.getFullYear(); m = now.getMonth(); }
  displayedYear = y; displayedMonth = m;

  const firstDay = new Date(y, m, 1);
  monthTitle.textContent = firstDay.toLocaleString("default", { month: "long", year: "numeric" });
  calGrid.innerHTML = "";

  const startDay = firstDay.getDay();
  const daysInMonth = new Date(y, m + 1, 0).getDate();

  for (let i = 0; i < startDay; i++) {
    const e = document.createElement("div");
    e.className = "day-tile";
    e.style.visibility = "hidden";
    calGrid.appendChild(e);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(y, m, d);
    const iso = formatDateKey(date);
    const div = document.createElement("div");
    div.className = "day-tile";
    div.textContent = d;

    if (closedDates[iso]) div.classList.add("closed");
    else if (date < new Date().setHours(0,0,0,0)) div.style.opacity = 0.4;
    else {
      div.onclick = () => {
        dateInput.value = iso;
        loadSlots(iso);
        showToast("Selected " + iso, "success");
      };
    }

    const today = new Date();
    today.setHours(0,0,0,0);
    if (date.getTime() === today.getTime()) div.classList.add("today");
    calGrid.appendChild(div);
  }
}

prevMonth.onclick = () => {
  const d = new Date(displayedYear, displayedMonth - 1, 1);
  renderCal(d.getFullYear(), d.getMonth());
};
nextMonth.onclick = () => {
  const d = new Date(displayedYear, displayedMonth + 1, 1);
  renderCal(d.getFullYear(), d.getMonth());
};
renderCal();

/* ------------------------- LOAD SLOTS ------------------------- */
async function loadSlots(dateKey) {
  slotsGrid.innerHTML = "";
  const countsSnap = await get(ref(db, `slot_counts/${dateKey}`));
  const counts = countsSnap.exists() ? countsSnap.val() : {};
  TIME_SLOTS.forEach(slot => {
    const k = slotKey(slot), c = counts[k] || 0, full = c >= maxSlots;
    const b = document.createElement("button");
    b.className = "slot-btn";
    b.textContent = slot + (full ? " ‚Ä¢ FULL" : "");
    if (full) b.classList.add("booked");
    else b.onclick = () => {
      timeInput.value = slot;
      document.querySelectorAll(".slot-btn").forEach(x => x.classList.remove("selected"));
      b.classList.add("selected");
    };
    slotsGrid.appendChild(b);
  });
}

/* ------------------------- FORM SUBMIT ------------------------- */
document.getElementById("bookingForm").onsubmit = async e => {
  e.preventDefault();
  const name = document.getElementById("name").value.trim(),
        email = document.getElementById("email").value.trim(),
        phone = document.getElementById("phone").value.trim(),
        notes = document.getElementById("notes").value.trim(),
        service = document.getElementById("service").value.trim(),
        date = dateInput.value,
        time = timeInput.value;

  if (!name || !email || !phone || !service || !date || !time)
    return showToast("Please complete all fields", "error");

  const sKey = slotKey(time), slotRef = ref(db, `slot_counts/${date}/${sKey}`);
  const tx = await runTransaction(slotRef, c => {
    if (!c) c = 0;
    if (c >= maxSlots) return;
    return c + 1;
  });

  if (!tx.committed) return showToast("Slot full, choose another", "error");

  const booking = { name, email, phone, service, date, time, notes, timestamp: Date.now() };
  await set(push(ref(db, `appointments/${date}/${sKey}`)), booking);

  try {
    await emailjs.send("service_qtacvtn", "template_edmr2cm", {
      to_email: email,
      user_name: name,
      appointment_service: service,
      appointment_date: date,
      appointment_time: time
    });
    showToast("Booking Confirmed! Check your email.", "success");
    document.getElementById("bookingForm").reset();
    slotsGrid.innerHTML = "";
  } catch (err) {
    showToast("Email send failed", "error");
  }
};

/* ------------------------- MODAL MENU ------------------------- */
const modalOverlay = document.getElementById("modalOverlay");
const modalMenu = document.getElementById("modalMenu");
const sectionContent = document.getElementById("sectionContent");
const sectionBody = document.getElementById("sectionBody");
const menuBtn = document.getElementById("menuBtn");
const closeModal = document.getElementById("closeModal");
const backBtn = document.getElementById("backBtn");

menuBtn.onclick = () => {
  modalOverlay.style.display = "flex";
  modalMenu.style.display = "block";
  sectionContent.style.display = "none";
};
closeModal.onclick = () => modalOverlay.style.display = "none";
backBtn.onclick = () => {
  sectionContent.style.display = "none";
  modalMenu.style.display = "block";
};

const modalSections = {
  about: `
    <img src="https://i.imgur.com/t942gBV.png" class="modal-logo">
    <h3>About Us</h3>
    <p><b>Orthodontics, Implant & General Dentistry</b></p>
    <p>Dr. Jeff Esparagoza provides dental services such as orthodontics, implant, and general dentistry.</p>
  `,
  services: `
    <h3>Our Dental Services</h3>
    <ul>
      <li>Pediatric Dentistry ‚Äî 30 minutes</li>
      <li>Restorative Dentistry (Tooth Filling) ‚Äî 30 minutes</li>
      <li>Prosthodontics ‚Äî 30 minutes</li>
      <li>Veneers Dental Crowns ‚Äî 30 minutes</li>
      <li>Cosmetic Dentistry ‚Äî 30 minutes</li>
      <li>Oral Surgery ‚Äî 30 minutes</li>
      <li>Orthodontics ‚Äî 30 minutes</li>
    </ul>
  `,
  protocols: `
    <h3>COVID-19 Dental Practice Protocols</h3>
    <p>Coronavirus Disease 2019 (COVID-19) is an infectious disease caused by SARS-Cov-2.</p>
    <p>Common symptoms include fever, cough, fatigue, and loss of smell.</p>
    <p>Dental staff are at high risk, so everyone must follow our protocols:</p>
    <ul>
      <li>NO MASK, NO ENTRY</li>
      <li>OBSERVE SOCIAL DISTANCING</li>
      <li>ALCOHOL IS AVAILABLE FOR PATIENT USE</li>
      <li>Only patients allowed inside treatment room</li>
      <li>No companions except for minors/elders</li>
    </ul>
    <p><b>Clinic Hours:</b> Monday‚ÄìSaturday, 9:00 AM ‚Äì 4:00 PM (by appointment)</p>
  `,
  contact: `
    <h3>Contact Us</h3>
    <p>üìç Kidapawan City, North Cotabato, Philippines</p>
    <p>üìû 0977 780 9537</p>
    <p>‚úâÔ∏è esparagoza.jeffrey@gmail.com</p>
  `
};

document.querySelectorAll(".menu-tile").forEach(btn => {
  btn.onclick = () => {
    const section = btn.getAttribute("data-section");
    sectionBody.innerHTML = modalSections[section] || "";
    modalMenu.style.display = "none";
    sectionContent.style.display = "block";
  };
});
</script>
</body>
</html>
